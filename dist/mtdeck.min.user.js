// ==UserScript==
// @name MTDeck
// @version 1.8.2
// @author mkizka
// @description TweetDeckをスマホアプリのように使えるようにするUserScript
// @homepage https://github.com/mkizka/MTDeck
// @match https://tweetdeck.twitter.com
// ==/UserScript==
!function(){"use strict";const e={en:{extensionDescription:{message:"A browser extension to customize TweetDeck for mobile"},configTitle:{message:"Preference"},configSaveLabel:{message:"Save and Reload"},configBackLabel:{message:"Close"},configLinksLabel:{message:"Bug/Feature Report"},configOptionBackAtMounted:{message:"Close notifications at startup"},configOptionNoAnimation:{message:"Disable animation"},configOptionHideImages:{message:"Hide image thumbnails on tweet"},configOptionLazyLoadImages:{message:"Lazy load image thumbnails on tweet"},configOptionMenuOpenRange:{message:"Range to open menu with swipe"}},ja:{extensionDescription:{message:"TweetDeckをスマホアプリのように使えるようにするアドオン"},configTitle:{message:"設定メニュー"},configSaveLabel:{message:"保存して再読み込み"},configBackLabel:{message:"戻る"},configLinksLabel:{message:"バグ報告/機能提案など"},configOptionBackAtMounted:{message:"起動直後に開いている通知などを閉じる"},configOptionNoAnimation:{message:"アニメーションの無効化"},configOptionHideImages:{message:"ツイートの画像サムネイルを非表示"},configOptionLazyLoadImages:{message:"ツイートの画像サムネイルを遅延読み込み"},configOptionMenuOpenRange:{message:"左からのスワイプでメニューを開く範囲"}}},t=e=>{const t=(new DOMParser).parseFromString(e,"text/html").querySelector("body");if(null==(null==t?void 0:t.firstElementChild))throw Error;return t.firstElementChild},n=e=>{document.querySelectorAll(e).forEach((e=>e.click()))},i=t=>{if("undefined"!=typeof chrome&&void 0!==chrome.i18n)return chrome.i18n.getMessage(t);const n=/ja/.test(window.navigator.language)?"ja":"en";return e[n][t].message||""};class o{constructor(){this.$container=null,this.$columnNavigator=null,this.isNoAnimation=!1}init(){this.$container=document.querySelector("#container"),this.$columnNavigator=document.querySelector("#column-navigator"),this.isNoAnimation=document.body.classList.contains("mtdeck-no-animation"),this.isNoAnimation&&(this.setNoAnimationJump(),this.setNoAnimationObserver())}scrollTo(e){const{left:t}=e.getBoundingClientRect(),n=this.isNoAnimation?"auto":"smooth";this.$container.scrollBy({left:t,behavior:n});this.$columnNavigator.querySelector(`li[data-column=${e.dataset.column}]`).scrollIntoView({behavior:n,inline:"nearest"})}setNoAnimationObserver(){new MutationObserver((()=>this.setNoAnimationJump())).observe(this.$columnNavigator,{childList:!0,attributes:!1,characterData:!1})}setNoAnimationJump(){this.$columnNavigator.querySelectorAll("li[data-column] a").forEach((e=>{(function(e){const n=t(e.outerHTML);return e.insertAdjacentElement("afterend",n),e.remove(),n})(e).addEventListener("click",(t=>{this.$container.querySelector(`section[data-column=${e.dataset.column}]`).scrollIntoView({inline:"nearest"})}))}))}}class a{static get isOpen(){return!document.body.classList.contains("mtdeck-close")}static open(){a.isOpen||document.body.classList.remove("mtdeck-close")}static close(){a.isOpen&&document.body.classList.add("mtdeck-close")}}class s{constructor(){this.activeQuery="",this.clickQuery=""}get exists(){return document.querySelectorAll(this.activeQuery).length>0}back(){n(this.clickQuery)}}class d extends s{constructor(){super(...arguments),this.activeQuery=".mtdeck-config.is-open",this.clickQuery="#mtdeck-config-back"}}class c extends s{constructor(){super(...arguments),this.activeQuery=".app-content.is-open",this.clickQuery=".js-drawer-close"}}class r extends s{constructor(){super(...arguments),this.activeQuery="#open-modal .js-column-state-social-proof",this.clickQuery="#open-modal .js-tweet-social-proof-back"}}class m extends s{constructor(){super(...arguments),this.activeQuery="#open-modal .js-column-state-detail-view",this.clickQuery="#open-modal .js-column-back"}}class l extends s{constructor(){super(...arguments),this.activeQuery=".mdl .btn-back",this.clickQuery=".mdl .btn-back"}}class u extends s{constructor(){super(...arguments),this.activeQuery=".mdl .js-dismiss",this.clickQuery=".mdl .js-dismiss"}}class h extends s{constructor(){super(...arguments),this.activeQuery="#container .js-column-state-social-proof",this.clickQuery="#container .js-tweet-social-proof-back"}}class p extends s{constructor(){super(...arguments),this.activeQuery="#container .js-column-state-detail-view",this.clickQuery="#container .js-column-back"}}class g extends s{constructor(){super(...arguments),this.activeQuery=".is-options-open",this.clickQuery=".is-options-open .js-action-header-button"}}class b extends s{get exists(){return a.isOpen}back(){a.close()}}class k{constructor(){this.backables=[new d,new c,new r,new m,new l,new u,new h,new p,new g,new b]}back(){for(let e of this.backables)if(e.exists){e.back();break}}}class y{constructor(e){this.onTap=()=>{},this.onSwipe=()=>{},this.start={x:0,y:0,time:0},this.end={x:0,y:0,time:0},e.addEventListener("click",(()=>this.onTap())),e.addEventListener("touchstart",(e=>{this.start={x:e.touches[0].screenX,y:e.touches[0].screenY,time:(new Date).getTime()}})),e.addEventListener("touchmove",(e=>{this.end={x:e.touches[0].screenX,y:e.touches[0].screenY,time:(new Date).getTime()}})),e.addEventListener("touchend",(e=>{if(this.isSwipedX){const e=this.start.x<this.end.x?"right":"left";this.onSwipe(this.start.x,e)}}))}get isSwipedX(){const e=this.end.x-this.start.x,t=this.end.y-this.start.y,n=this.end.time-this.start.time,i=Math.sqrt(Math.pow(e,2)+Math.pow(t,2))/n;return Math.abs(t/e)<=1&&Math.abs(e)>=10&&Math.abs(i)>=.3}}class f{constructor(){this.$el=null,this.items=[{label:i("configOptionBackAtMounted"),name:"mtdBackAtMounted",type:"checkbox",default:"true"},{label:i("configOptionNoAnimation"),name:"mtdNoAnimation",type:"checkbox",default:"false"},{label:i("configOptionHideImages"),name:"mtdHideImages",type:"checkbox",default:"false"},{label:i("configOptionLazyLoadImages"),name:"mtdLazyLoadImages",type:"checkbox",default:"false"},{label:i("configOptionMenuOpenRange"),name:"mtdMenuOpenRange",type:"number",default:"30"}]}getString(e){return localStorage.getItem(e).toString()}getNumber(e){return parseFloat(localStorage.getItem(e))}getBoolean(e){return"true"===localStorage.getItem(e)}open(){this.$el.classList.add("is-open")}close(){this.save(),this.$el.classList.remove("is-open")}isOpen(){return this.$el.classList.contains("is-open")}save(){document.querySelectorAll(".mtdeck-config-input").forEach((e=>{"checkbox"===e.type?localStorage.setItem(e.name,`${e.checked}`):localStorage.setItem(e.name,e.value)}))}saveDefault(){this.items.forEach((e=>{null===localStorage.getItem(e.name)&&localStorage.setItem(e.name,e.default)}))}createInfo(){this.$el.appendChild(t(`\n      <div class="mtdeck-config-item">\n        <p>MTDeck v1.8.2</p>\n        <p>${i("configLinksLabel")}:\n          <a href="https://github.com/mkizka/MTDeck" target="_blank">Github</a>\n          <a href="https://twitter.com/mkizka">Twitter</a>\n        </p>\n      </div>\n    `))}createFooter(){this.$el.appendChild(t(`\n      <div class="mtdeck-config-footer">\n        <button id="mtdeck-config-save">${i("configSaveLabel")}</button>\n        <button id="mtdeck-config-back">${i("configBackLabel")}</button>\n      </div>\n    `)),document.querySelector("#mtdeck-config-save").addEventListener("click",(()=>{this.save(),location.reload()})),document.querySelector("#mtdeck-config-back").addEventListener("click",(()=>{this.close()}))}createForm(){this.items.forEach((e=>{const n=t(`\n        <input class="mtdeck-config-input" type="${e.type}" name="${e.name}"/>\n      `);"checkbox"===e.type?n.defaultChecked=this.getBoolean(e.name):n.defaultValue=this.getString(e.name),this.$el.insertAdjacentElement("beforeend",t(`\n        <label class="mtdeck-config-item">\n          ${n.outerHTML}  \n          ${e.label}\n        </label>\n      `))}))}createSettingButton(){const e=document.querySelector(".js-app-settings"),n=t(e.outerHTML);n.dataset.action="mtdeckConfig",n.dataset.title="MTDeck Config",n.classList.add("mtdeck-config-button"),n.querySelector(".app-nav-link-text").insertAdjacentText("afterbegin","MTD"),e.parentElement.insertAdjacentElement("afterbegin",n),n.addEventListener("click",(e=>this.open()))}createConfigBase(){this.$el=t(`\n      <div class="mtdeck-config">\n        <h1 class="mtdeck-config-item">${i("configTitle")}</h1>\n      </div>\n    `),document.body.appendChild(this.$el)}init(){this.saveDefault(),this.createConfigBase(),this.createInfo(),this.createForm(),this.createFooter(),this.createSettingButton()}}(e=>{const t=document.createElement("style");t.setAttribute("type","text/css"),t.innerText=e,document.head.appendChild(t)})('body.mtdeck button[data-drawer=compose] {\n  z-index: 1;\n  position: fixed !important;\n  right: 20px;\n  bottom: 60px;\n  width: 4rem !important;\n  height: 4rem !important;\n  filter: drop-shadow(5px 5px 5px rgba(0, 0, 0, 0.7));\n}\nbody.mtdeck .app-columns {\n  padding: 0 0 50px 0 !important;\n}\nbody.mtdeck .app-content {\n  left: 0 !important;\n}\nbody.mtdeck .app-columns-container {\n  overflow-x: hidden;\n  overflow-y: auto;\n}\nbody.mtdeck section.column,\nbody.mtdeck .js-modal-panel,\nbody.mtdeck .prf-header,\nbody.mtdeck .prf-header-inner-overlay,\nbody.mtdeck .social-proof-container {\n  width: 100% !important;\n}\nbody.mtdeck .overlay:before {\n  margin-right: -5px;\n}\nbody.mtdeck .mdl {\n  width: 100% !important;\n  overflow-x: hidden;\n}\nbody.mtdeck .mdl .mdl-inner {\n  padding: 5px;\n}\nbody.mtdeck .mdl .mdl-inner .js-right-column {\n  overflow-x: hidden;\n}\nbody.mtdeck .mdl .mdl-inner .mdl-column:first-child {\n  display: none;\n}\nbody.mtdeck .mdl .mdl-inner .mdl-column:not(:first-child) {\n  width: 100% !important;\n}\nbody.mtdeck .mdl .mdl-dismiss {\n  right: 10px !important;\n}\nbody.mtdeck .med-tweet {\n  width: 100% !important;\n  left: 0 !important;\n}\nbody.mtdeck .old-composer-footer,\nbody.mtdeck .column-nav-flyout {\n  display: none;\n}\nbody.mtdeck .js-search-in-popover .popover {\n  width: 200px !important;\n}\nbody.mtdeck .js-mediaembed .js-media-native-video,\nbody.mtdeck .js-mediaembed .youtube-player {\n  width: 100% !important;\n  position: fixed;\n  left: 0;\n  top: 0;\n  bottom: 0;\n  margin: auto !important;\n  z-index: 1;\n}\nbody.mtdeck .column-navigator {\n  top: 50px;\n}\n\nbody.mtdeck .app-content {\n  will-change: transform;\n}\nbody.mtdeck .app-content.is-open {\n  margin-right: 0 !important;\n  transform: translateX(100%) !important;\n}\nbody.mtdeck .drawer[data-drawer=compose] {\n  left: -100%;\n  width: 100%;\n}\nbody.mtdeck .drawer[data-drawer=accountSettings] {\n  left: calc(-1 * 100vw + 60px);\n  width: calc(100vw - 60px);\n}\nbody.mtdeck button.js-hide-drawer {\n  display: none !important;\n}\n\nbody.mtdeck .js-int-scroller {\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  background-color: #1c2938;\n  overflow-x: auto;\n  white-space: nowrap;\n  padding-top: 10px;\n  height: 40px;\n}\nbody.mtdeck .js-int-scroller .column-nav-item {\n  height: 35px;\n}\nbody.mtdeck .js-int-scroller .column-nav-item .icon-medium {\n  font-size: 20px;\n}\nbody.mtdeck .js-int-scroller .column-nav-item .js-header-action {\n  padding-left: 12px !important;\n  padding-right: 12px !important;\n}\nbody.mtdeck .hide-detail-view-inline .js-int-scroller,\nbody.mtdeck .with-nav-border-t:before {\n  display: none;\n}\nbody.mtdeck .column-nav-item {\n  display: inline-block;\n}\n\nbody.mtdeck-close header.app-header {\n  position: relative;\n  top: -50px;\n}\nbody.mtdeck-close div.app-columns-container {\n  left: 0 !important;\n}\n\n.mtdeck-config {\n  display: none;\n  width: 100%;\n  height: 100%;\n  position: fixed;\n  z-index: 201;\n  background-color: #1c2938;\n  padding: 20px;\n}\n.mtdeck-config.is-open {\n  display: block;\n}\n.mtdeck-config-button {\n  color: blueviolet !important;\n}\n.mtdeck-config-item {\n  margin-bottom: 20px !important;\n}\n.mtdeck-config-input[type=number] {\n  width: 80px;\n  margin-right: 10px;\n}\n.mtdeck-config-footer {\n  position: fixed;\n  bottom: 20px;\n}\n\nbody.mtdeck-no-animation,\nbody.mtdeck-no-animation *:not(iframe) {\n  transition-duration: 1ms !important;\n}\n\nbody.mtdeck-hide-images .js-media:not(.detail-preview) {\n  height: 25px !important;\n  border-radius: 0 !important;\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-sensitive {\n  height: 1rem;\n  background-color: transparent;\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-sensitive::before {\n  content: "[sensitive]";\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-sensitive div {\n  display: none;\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:first-child,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .js-media-preview-container {\n  width: 100% !important;\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:first-child .media-item,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:first-child .media-image,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .js-media-preview-container .media-item,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .js-media-preview-container .media-image {\n  height: 0;\n  width: max-content;\n  background-image: none !important;\n  border-radius: 0;\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:first-child .media-item::before,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:first-child .media-image::before,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .js-media-preview-container .media-item::before,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .js-media-preview-container .media-image::before {\n  content: "[media]";\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:first-child .media-item *,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:first-child .media-image *,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .js-media-preview-container .media-item *,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .js-media-preview-container .media-image * {\n  display: none !important;\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:not(:first-child) {\n  display: none !important;\n}\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:not(:first-child) .media-item,\nbody.mtdeck-hide-images .js-media:not(.detail-preview) .media-image-container:not(:first-child) .media-image {\n  background-image: none !important;\n}\nbody.mtdeck-hide-images .item-box-full-bleed .media-item,\nbody.mtdeck-hide-images .item-box-full-bleed .media-image {\n  margin: auto !important;\n}\n\nbody.mtdeck-lazy-load-image .media-item,\nbody.mtdeck-lazy-load-image .media-image {\n  background-image: none !important;\n}\n\nbody.mtdeck[data-btd-ready=true] .media-size-medium.btd-aspect-ratio-thumbnail,\nbody.mtdeck[data-btd-ready=true] .media-size-large.btd-aspect-ratio-thumbnail {\n  padding-top: calc(var(--btd-thumb-height) / var(--btd-thumb-width) * 100%);\n}\nbody.mtdeck[data-btd-ready=true] .js-int-scroller {\n  background-color: var(--btd-theme-background-lighter);\n}'),window.MTD=new class{constructor(){this.config=new f,this.scrollController=new o,this.backController=new k,this.columnIndex=0,this.$columns=[],this.$drawerOpenButton=null}ready(){const e=setInterval((()=>{this.$drawerOpenButton=document.querySelector("button[data-drawer=compose]"),this.$drawerOpenButton&&(this.config.init(),this.init(),this.scrollController.init(),clearInterval(e))}),100)}update(){this.$columns=[],document.querySelectorAll("section.column").forEach((e=>{this.$columns.push(e)})),this.fixColumnState(),this.updateTweetButton()}fixColumnState(){this.columnIndex=0;let e=this.$columns[0];for(let t=1;t<this.$columns.length;t++)Math.pow(this.$columns[t].getBoundingClientRect().left,2)<Math.pow(e.getBoundingClientRect().left,2)&&(e=this.$columns[t],this.columnIndex=t);e.scrollIntoView()}updateTweetButton(){const e=document.querySelector(".tweet-button");setTimeout((()=>{this.$columns[this.columnIndex].classList.contains("js-column-state-detail-view")?e.style.display="none":e.style.display="block"}),200)}init(){document.body.classList.add("mtdeck"),a.close();const e=document.querySelector("div.app-columns-container");if(this.config.getBoolean("mtdBackAtMounted")&&n(".js-dismiss"),this.config.getBoolean("mtdNoAnimation")&&document.body.classList.add("mtdeck-no-animation"),this.config.getBoolean("mtdHideImages"))document.body.classList.add("mtdeck-hide-images");else if(this.config.getBoolean("mtdLazyLoadImages")){document.body.classList.add("mtdeck-lazy-load-image");!function(e){const t=new IntersectionObserver((e=>{for(const t of e)if(t.isIntersecting){const e=t.target.style;e.setProperty("background-image",e.backgroundImage,"important")}})),n=new MutationObserver((e=>{for(const n of e)n.addedNodes.forEach((e=>{if("querySelector"in e){const n=e.querySelectorAll(".media-item, .media-image");n&&n.forEach((e=>t.observe(e)))}}))}));e.forEach((e=>{n.observe(e,{childList:!0,attributes:!1,characterData:!1,subtree:!0})}))}([e,document.querySelector("#open-modal")])}this.update();const t=new y(e);t.onTap=()=>{this.update(),a.close()};const i=this.config.getNumber("mtdMenuOpenRange");t.onSwipe=(e,t)=>{"right"==t?e<i?a.open():this.backColumn():this.pushColumn()},history.pushState(null,"",null),window.addEventListener("popstate",(e=>this.back())),this.$drawerOpenButton.addEventListener("click",(e=>{a.close()}))}back(){this.update(),this.backController.back(),history.pushState(null,"",null)}pushColumn(){this.update(),a.close(),this.columnIndex<this.$columns.length-1&&(this.columnIndex++,this.scrollController.scrollTo(this.$columns[this.columnIndex]))}backColumn(){this.update(),a.close(),0==this.columnIndex?a.open():(this.columnIndex--,this.scrollController.scrollTo(this.$columns[this.columnIndex]))}},window.MTD.ready()}();
